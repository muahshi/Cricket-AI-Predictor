<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cricket Predictor (Mini App)</title>
    <!-- Telegram Web App SDK and Tailwind CSS for mobile-first design -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Professional Dark Theme */
        body {
            /* Telegram theme colors for seamless integration */
            background-color: var(--tg-theme-bg-color, #1f2937); /* Dark Slate Grey */
            color: var(--tg-theme-text-color, #e5e7eb); /* Light Grey text */
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s;
        }
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #374151); /* Slightly lighter card */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border-radius: 0.75rem; /* rounded-xl equivalent */
        }
        .header-main {
            color: #f97316; /* Orange for professionalism */
        }
        .btn-predict {
            background-color: #ef4444; /* Red for Call to Action */
            color: #ffffff;
            transition: all 0.2s ease;
        }
        .btn-predict:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        input, select {
            background-color: var(--tg-theme-secondary-bg-color, #4b5563) !important;
            color: var(--tg-theme-text-color, #f3f4f6) !important;
            border: 1px solid #6b7280;
        }
        .spinner {
            border-top-color: #f3f4f6;
            border-right-color: #f3f4f6;
            border-bottom-color: transparent;
            border-left-color: transparent;
        }
        .match-item {
            cursor: pointer;
            transition: background-color 0.1s;
            border-left: 5px solid #10b981; /* Green indicator */
        }
        .match-item:hover {
             background-color: #4b5563;
        }
        .section-header {
            border-bottom: 2px solid #4b5563;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .highlight-text {
            color: #f97316; /* Orange highlight */
            font-weight: 700;
        }
        .money-link {
            background-color: #0d9488; /* Teal for money link */
            transition: all 0.2s ease;
        }
        .money-link:hover {
            background-color: #0f766e;
            transform: scale(1.02);
        }
        /* Style for the copy button */
        .copy-btn {
            background-color: #2563eb;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .copy-btn:hover {
            background-color: #1d4ed8;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <!-- Header -->
    <header class="w-full max-w-lg mb-6 text-center">
        <h1 class="text-3xl font-extrabold header-main mb-2">üèè CRICKET AI PREDICTOR </h1>
        <p class="text-gray-400">Deep statistical analysis aur winning odds.</p>
    </header>

    <!-- Main Content Card -->
    <div id="app-container" class="w-full max-w-lg card p-6">
        
        <!-- User ID Display (Firestore requirement) -->
        <div id="user-info" class="text-xs text-center p-2 mb-4 rounded-lg hidden" style="background-color: var(--tg-theme-secondary-bg-color);">
            <p>Aapki User ID: <span id="user-id-span" class="font-mono text-yellow-400 break-all"></span></p>
        </div>

        <!-- App Status Bar (To show connection status) -->
        <div id="auth-status-bar" class="text-center p-2 mb-4 rounded-lg text-sm font-semibold bg-blue-700 text-blue-200">
            Server se jud raha hai...
        </div>

        <!-- Today's Matches List Section (FREE TIER - Trust Builder) -->
        <h2 class="text-lg font-bold mb-3 text-green-400">‚úÖ Aaj Ke Matches (Quick Odds & Teaser)</h2>
        <div id="today-matches-list" class="space-y-3 mb-6">
            <!-- Matches and loading status will be displayed here -->
            <p id="match-list-status" class="text-center text-sm text-gray-400">Matches ki live list load ho rahi hai, please wait...</p>
        </div>

        <!-- Input Section for detailed analysis -->
        <div class="space-y-4 pt-4 border-t border-gray-700">
            <label for="match-query" class="block text-sm font-medium text-gray-300">Detailed Report ke liye Match ka naam enter karein:</label>
            <input type="text" id="match-query" class="w-full p-3 rounded-lg border-none focus:ring-2 focus:ring-red-500" 
                   placeholder="e.g., India vs Pakistan 2nd T20I" aria-label="Enter Match Details">
            
            <button id="predict-button" class="btn-predict w-full p-3 text-lg font-extrabold rounded-lg flex items-center justify-center" onclick="handlePrediction()">
                <span id="button-text">üöÄ Detailed Analysis Generate Karein</span>
                <div id="loading-spinner" class="w-5 h-5 border-4 rounded-full spinner animate-spin ml-2 hidden"></div>
            </button>
        </div>

        <!-- Result Section -->
        <div id="result-area" class="mt-8 space-y-4">
            <!-- Prediction results or message will be injected here -->
        </div>
        
    </div>

    <!-- Modal for Premium Access -->
    <div id="premium-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="card p-6 w-full max-w-md">
            <h3 class="text-2xl font-extrabold text-pink-400 mb-4">üîë PREMIUM ACCESS REQUIRED</h3>
            <p class="text-gray-300 mb-4">Complete Pitch Report, Key Battles, aur Toss Decision Prediction unlock karne ke liye **‚Çπ99/month** ka subscription lein.</p>
            
            <div class="bg-gray-700 p-4 rounded-lg mb-4">
                <p class="font-bold text-gray-400 mb-2">Manual Payment (UPI)</p>
                <div class="flex justify-between items-center">
                    <span id="upi-id-display" class="text-yellow-400 text-xl font-mono select-all"></span>
                    <button class="copy-btn" onclick="copyUpiId(document.getElementById('upi-id-display').textContent)">Copy ID</button>
                </div>
            </div>

            <p class="text-sm text-gray-400 mb-6">Payment ‚Çπ99 karne ke baad neeche diye gaye button par click karein. (Aapka access 24 hours mein activate ho jayega)</p>
            
            <button class="w-full p-3 bg-green-600 hover:bg-green-700 font-extrabold rounded-lg text-white mb-3" onclick="handlePaymentDone()">
                ‚úîÔ∏è I Have Paid (Access Activate Karein)
            </button>
            <button class="w-full p-3 bg-gray-600 hover:bg-gray-700 font-extrabold rounded-lg text-gray-300" onclick="hidePremiumModal()">
                Cancel
            </button>
        </div>
    </div>


    <!-- Firebase and Logic Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION (CHANGE THESE) ---
        // UPI ID HAS BEEN UPDATED HERE:
        const UPI_ID = "Muahshi7759@ybl"; // <--- APNI UPI ID YAHAN DALEIN
        const PREMIUM_TELEGRAM_LINK = "YOUR_PREMIUM_CHANNEL_LINK"; // <--- APNA PREMIUM GROUP LINK DALEIN
        const AFFILIATE_LINK = "YOUR_AFFILIATE_LINK"; // <--- APNA BETTING PLATFORM LINK DALEIN

        // --- MANDATORY CANVAS GLOBALS (Keep these as-is) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;
        let userStats = { freeCount: 0, isPremium: false }; // Track user's status

        window.handlePrediction = handlePrediction;
        window.copyUpiId = copyUpiId;
        window.hidePremiumModal = hidePremiumModal;
        window.handlePaymentDone = handlePaymentDone;


        // --- TELEGRAM INIT ---
        window.onload = function() {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand(); 
                if (Telegram.WebApp.themeParams) {
                    document.body.style.backgroundColor = Telegram.WebApp.themeParams.bg_color;
                }
            }
            // Update UPI ID in modal
            document.getElementById('upi-id-display').textContent = UPI_ID;
        };

        // --- FIREBASE INIT AND AUTH ---
        if (firebaseConfig) {
            setLogLevel('Debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            const statusBar = document.getElementById('auth-status-bar');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    try {
                        const anonUser = await signInAnonymously(auth);
                        userId = anonUser.user.uid;
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                    }
                }
                
                isAuthReady = true;
                const userIdSpan = document.getElementById('user-id-span');
                if (userIdSpan) {
                    userIdSpan.textContent = userId;
                    document.getElementById('user-info').classList.remove('hidden');
                }
                
                // Load user stats and update status bar
                await loadUserStats();

                // --- STATUS UPDATE: READY ---
                if (statusBar) {
                    statusBar.textContent = "‚úÖ App Ready. Shuru karein!";
                    statusBar.className = "text-center p-2 mb-4 rounded-lg text-sm font-semibold bg-green-700 text-green-200";
                }

                // Start fetching matches only after auth is ready
                fetchTodayMatches();
            });

            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(error => {
                    console.error("Custom token sign-in failed:", error);
                    // --- STATUS UPDATE: ERROR ---
                    if (statusBar) {
                        statusBar.textContent = "‚ùå ERROR: Authentication Failed. App Refresh karein.";
                        statusBar.className = "text-center p-2 mb-4 rounded-lg text-sm font-semibold bg-red-700 text-red-200";
                    }
                });
            }
        } else {
            console.error("Firebase config missing.");
        }

        // --- FIRESTORE USER STATS ---
        async function loadUserStats() {
            if (!db || !userId) return;
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`, 'stats');
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists()) {
                    userStats = docSnap.data();
                    userStats.freeCount = userStats.freeCount || 0;
                    userStats.isPremium = userStats.isPremium || false;
                } else {
                    // Create initial document
                    await setDoc(userDocRef, userStats);
                }
            } catch(e) {
                console.error("Error loading user stats:", e);
            }
        }

        async function incrementFreeCount() {
            if (!db || !userId) return;
            userStats.freeCount += 1;
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`, 'stats');
                await updateDoc(userDocRef, { 
                    freeCount: userStats.freeCount,
                    lastPrediction: new Date().toISOString()
                });
            } catch(e) {
                console.error("Error updating free count:", e);
            }
        }
        
        // --- API CALL UTILITY ---
        // ***************************************************************
        // !!! IMPORTANT: APNI GEMINI API KEY YAHAN DALO !!!
        // ***************************************************************
        // NOTE: The user's key was previously added here.
        const API_KEY = "AIzaSyCtcUXO75GiuGEYp8WwhWqq0h4Cqi1X18E"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        async function fetchWithRetry(payload) {
            
            const maxRetries = 3;
            let attempt = 0;
            
            while (attempt < maxRetries) {
                try {
                    const fetchResponse = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (fetchResponse.status === 429) {
                        attempt++;
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!fetchResponse.ok) {
                        let errorDetail = await fetchResponse.text();
                        try { errorDetail = JSON.parse(errorDetail).error.message; } catch {}
                        throw new Error(`HTTP error! status: ${fetchResponse.status}. Detail: ${errorDetail.substring(0, 100)}...`);
                    }

                    return fetchResponse.json(); 

                } catch (error) {
                    console.error("Fetch failed:", error);
                    attempt = maxRetries; // Fail fast on non-rate-limit errors
                    throw error;
                }
            }
            throw new Error("API request failed after all retries.");
        }


        // --- MATCH LIST FETCH (FREE TIER - Trust Builder) ---
        async function fetchTodayMatches() {
            const listContainer = document.getElementById('today-matches-list');
            const statusMessage = document.getElementById('match-list-status');
            
            statusMessage.textContent = "Matches ki live list load ho rahi hai...";
            statusMessage.className = "text-center text-sm text-green-400";
            listContainer.innerHTML = '';
            listContainer.appendChild(statusMessage);

            const systemPrompt = `Aap ek cricket match listing aur quick prediction expert hain. Aapka kaam hai aaj (current date) hone wale sabhi major international aur domestic cricket matches ko Google Search ka use karke dhundhna. Har match ke liye ek quick, statistically-based winning chance (percentage) aur saath mein ek chota sa teaser (Pitch aur Venue ke bare mein 12 words se kam ka description) bhi dena hai.

            Response ka format strictly JSON array of objects hona chahiye:
            [
              {
                "matchName": "Team A vs Team B, Tournament Name",
                "winningLikelihood": "Team A: 60%, Team B: 40%",
                "winnerTeam": "Team A",
                "teaserDetail": "Wicket flat hai, high-scoring game expected."
              },
              ...
            ]
            Sirf matches ki list dena hai, koi extra text nahi.`;

            const userQuery = "Aaj ke saare cricket matches, unki winning percentage, kon jeetega aur pitch/venue ka 1-line teaser batao.";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                matchName: { type: "STRING" },
                                winningLikelihood: { type: "STRING" },
                                winnerTeam: { type: "STRING" },
                                teaserDetail: { type: "STRING" }
                            }
                        }
                    }
                }
            };
            
            try {
                const response = await fetchWithRetry(payload);
                const candidate = response?.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                     throw new Error("API se koi content nahi mila.");
                }

                const jsonText = candidate.content.parts[0].text;
                const matchesData = JSON.parse(jsonText);
                
                listContainer.innerHTML = ''; // Clear status message
                
                if (matchesData.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-sm text-red-400">Aaj koi major match nahi mila ya data abhi update nahi hua hai.</p>';
                    return;
                }

                matchesData.forEach(match => {
                    const matchItem = document.createElement('div');
                    matchItem.className = 'match-item card p-3 flex flex-col space-y-2';
                    matchItem.setAttribute('data-match-name', match.matchName);
                    // Click on match item starts analysis
                    matchItem.onclick = () => handlePrediction(match.matchName); 

                    const winningTeam = match.winnerTeam || 'N/A';
                    const likelihoodParts = (match.winningLikelihood || '').split(',').map(s => s.trim());
                    
                    let likelihoodDisplay = likelihoodParts.map(part => {
                        const isWinner = part.includes(winningTeam);
                        const colorClass = isWinner ? 'text-green-400 font-extrabold' : 'text-yellow-400 font-semibold';
                        return `<span class="${colorClass}">${part}</span>`;
                    }).join(' / ');


                    matchItem.innerHTML = `
                        <div class="flex justify-between items-center w-full">
                            <div>
                                <p class="font-bold text-base text-white">${match.matchName}</p>
                            </div>
                            <div class="text-right text-xs font-mono">
                                ${likelihoodDisplay}
                            </div>
                        </div>
                        <div class="w-full border-t border-gray-600 pt-1">
                             <p class="text-xs text-gray-400">Expected Winner: <span class="text-green-400 font-bold">${winningTeam}</span></p>
                             <p class="text-xs text-orange-300 mt-1">üìç Teaser: ${match.teaserDetail || 'Koi quick info nahi mili.'}</p>
                        </div>
                    `;
                    listContainer.appendChild(matchItem);
                });

                const instruction = document.createElement('p');
                instruction.className = 'text-center text-xs text-gray-500 mt-2';
                instruction.textContent = 'Full betting report (Pitch, Key Battles, Toss) ke liye, match par TAP karein.';
                listContainer.appendChild(instruction);


            } catch (error) {
                console.error("Error fetching or parsing match list:", error);
                
                if (error.message.includes("API Key Missing")) {
                    listContainer.innerHTML = '<p class="text-center text-sm text-red-400">üö® **ERROR:** API Key Missing. Code mein key update karein.</p>';
                } else if (error.message.includes("403") || error.message.includes("400")) {
                     listContainer.innerHTML = '<p class="text-center text-sm text-red-400">üö® **ERROR:** API Key Invalid ya Incorrect. Kripya check karein.</p>';
                } else {
                     listContainer.innerHTML = `<p class="text-center text-sm text-red-400">üö® Match list load nahi ho saki. Reason: ${error.message.substring(0, 50)}...</p>`;
                }
            }
        }
        
        // --- GATEWAY FUNCTION ---
        async function handlePrediction(matchNameFromList = null) {
            
            // Check if Firebase is ready 
            if (!isAuthReady || !userId) {
                displayMessage("Server abhi connect ho raha hai. Please 3-5 seconds wait karke dobara click karein.", 'info');
                return;
            }

            const queryInput = document.getElementById('match-query');
            let query;
            
            if (matchNameFromList) {
                query = matchNameFromList;
                queryInput.value = matchNameFromList; // Update input field if clicked from list
            } else {
                query = queryInput.value.trim();
            }

            if (!query) {
                displayMessage("Kripya match ka naam enter karein.", 'error');
                return;
            }
            
            // --- MONETIZATION LOGIC: Free Trial ---
            if (!userStats.isPremium && userStats.freeCount >= 1) {
                showPremiumModal(query); // Show payment gate after 1 free analysis
                return;
            }
            
            runPrediction(query);
        }
        
        // --- MODAL AND PREMIUM FUNCTIONS ---
        function showPremiumModal(matchQuery) {
            document.getElementById('premium-modal').classList.remove('hidden');
            document.getElementById('predict-button').setAttribute('data-query', matchQuery); // Store query for later use
        }

        function hidePremiumModal() {
            document.getElementById('premium-modal').classList.add('hidden');
        }

        function copyUpiId(upiId) {
            // Using execCommand for better compatibility inside iframes
            if (document.execCommand('copy')) {
                const el = document.createElement('textarea');
                el.value = upiId;
                el.setAttribute('readonly', '');
                el.style.position = 'absolute';
                el.style.left = '-9999px';
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                displayMessage("UPI ID Copy ho gayi: " + upiId, 'success');
            } else {
                 displayMessage("Copy karne mein fail, kripya manually copy karein.", 'error');
            }
        }

        async function handlePaymentDone() {
             // In a real app, this would trigger a check for payment status.
             // For this demo, we'll just close the modal and inform the user.
             hidePremiumModal();
             displayMessage("Payment request received. Aapka access 24 hours mein activate ho jayega. Tab tak aap free analysis ka use kar sakte hain.", 'info', true);
        }
        

        // --- DETAILED ANALYSIS EXECUTION (FULL DETAILS) ---
        async function runPrediction(query) {
            
            const loadingSpinner = document.getElementById('loading-spinner');
            const buttonText = document.getElementById('button-text');
            const predictButton = document.getElementById('predict-button');
            
            // UI State: Loading
            loadingSpinner.classList.remove('hidden');
            buttonText.textContent = 'Deep Analysis Ho Rahi Hai...';
            predictButton.disabled = true;
            
            document.getElementById('result-area').innerHTML = '';
            displayMessage("Gemini AI deep statistical report bana raha hai. Please wait...", 'info');
            
            const systemPrompt = `Aap ek world-class cricket match analysis aur statistical prediction expert hain. Aapka kaam hai user ke diye gaye cricket match ke liye ek detailed, objective analysis dena. Aapki analysis ek betting karne wale person ko dhyan mein rakh kar ki jayegi. Aapko woh saare key insights dene hain jo ek expert ko chahiye hote hain.
            
            Response ka format strictly JSON hona chahiye:
            {
              "MatchName": "...",
              "OverallWinner": "Team A",
              "WinningProbability": "Team A: X%, Team B: Y%",
              "PitchReport": "Detailed analysis of the venue's pitch (e.g., pace/spin support, average first innings score, boundary sizes).",
              "TossDecisionPrediction": "Suggest the ideal decision (bat/bowl) after winning the toss and explain why (e.g., dew factor, record).",
              "KeyBattles": [
                {"player1": "Batsman Name", "player2": "Bowler Name", "context": "Why this matchup is crucial and who has the edge (e.g., pace/spin weakness)."},
                ...
              ],
              "TopPerformersLikely": {
                  "Batsmen": "Name 2-3 key batsmen likely to score big (with reason).",
                  "Bowlers": "Name 2-3 key bowlers likely to take wickets (with reason)."
              },
              "FirstInningsScoreRange": "Predict a realistic score range for the first innings (e.g., 160-175)."
            }
            
            Apne analysis mein Google Search se current aur accurate data ka use karein.`;

            const userQuery = `Match: ${query}. Detailed betting analysis report do, jismein pitch, toss, key battles, aur score range ho.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            MatchName: { type: "STRING" },
                            OverallWinner: { type: "STRING" },
                            WinningProbability: { type: "STRING" },
                            PitchReport: { type: "STRING" },
                            TossDecisionPrediction: { type: "STRING" },
                            KeyBattles: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        player1: { type: "STRING" },
                                        player2: { type: "STRING" },
                                        context: { type: "STRING" }
                                    }
                                }
                            },
                            TopPerformersLikely: {
                                type: "OBJECT",
                                properties: {
                                    Batsmen: { type: "STRING" },
                                    Bowlers: { type: "STRING" }
                                }
                            },
                            FirstInningsScoreRange: { type: "STRING" }
                        }
                    }
                }
            };
            
            try {
                const response = await fetchWithRetry(payload);
                const candidate = response?.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                     throw new Error("API se koi content nahi mila.");
                }

                const jsonText = candidate.content.parts[0].text;
                const predictionData = JSON.parse(jsonText);
                
                renderPrediction(predictionData);
                
                // --- Update user stats AFTER successful prediction ---
                await incrementFreeCount();

                displayMessage("Full Betting Report Ready! ‚úÖ", 'success');
                
            } catch (error) {
                console.error("Prediction Error:", error);
                displayMessage(`Prediction failed: ${error.message}. Kripya dobara try karein.`, 'error');
            }

            // UI State: Finished
            loadingSpinner.classList.add('hidden');
            buttonText.textContent = 'üöÄ Detailed Analysis Generate Karein';
            predictButton.disabled = false;
        }

        function displayMessage(message, type) {
            const resultArea = document.getElementById('result-area');
            let messageDiv = document.getElementById('status-message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'status-message';
                messageDiv.classList.add('mt-4', 'p-3', 'rounded-lg', 'text-sm', 'font-medium', 'text-center', 'text-white', 'border', 'border-opacity-30');
                resultArea.prepend(messageDiv);
            }

            let bgColor, borderColor;
            if (type === 'error') {
                bgColor = 'bg-red-700';
                borderColor = 'border-red-400';
            } else if (type === 'info') {
                bgColor = 'bg-blue-700';
                borderColor = 'border-blue-400';
            } else if (type === 'success') {
                bgColor = 'bg-green-700';
                borderColor = 'border-green-400';
            } else {
                bgColor = 'bg-gray-700';
                borderColor = 'border-gray-400';
            }
            
            messageDiv.className = `mt-4 p-3 rounded-lg text-sm font-medium text-center text-white border border-opacity-30 ${bgColor} ${borderColor}`;
            messageDiv.textContent = message;

            if (window.Telegram && Telegram.WebApp) {
                if (type === 'error' && !message.includes("API Key")) {
                    Telegram.WebApp.showAlert(`Error: ${message}`);
                }
            }
        }

        function renderPrediction(data) {
            const resultArea = document.getElementById('result-area');
            // Remove previous status message
            const statusMessage = document.getElementById('status-message');
            if(statusMessage) { statusMessage.remove(); }
            
            resultArea.innerHTML = ''; 

            const winnerTeam = data.OverallWinner || 'N/A';
            const predictionLabel = userStats.freeCount === 0 ? 'FREE TRIAL' : (userStats.freeCount === 1 ? 'FINAL PREDICTION (Trial Used)' : 'PREMIUM REPORT');

            let html = `
                <h2 class="text-2xl font-extrabold text-red-400 mb-4 section-header">${data.MatchName || 'Match Report'} - FULL BETTING REPORT</h2>

                <!-- WINNER & PROBABILITY -->
                <div class="card p-4 mb-6 border-l-4 border-green-500 shadow-xl">
                    <p class="text-xs font-semibold text-gray-400">${predictionLabel}</p>
                    <h3 class="text-3xl font-extrabold text-green-400 mt-1">${winnerTeam}</h3>
                    <p class="text-sm mt-2 text-white">Odds: <span class="highlight-text">${data.WinningProbability || 'N/A'}</span></p>
                    <p class="text-xs text-gray-500 mt-2">Yeh prediction saare statistical factors ko dhyan mein rakhkar banayi gayi hai.</p>
                </div>

                <!-- PITCH, TOSS, SCORE -->
                <div class="card p-4 mb-6 space-y-4">
                    <div class="border-b border-gray-600 pb-3">
                        <h4 class="font-bold text-lg text-orange-400">üèüÔ∏è PITCH & SCORE ANALYSIS</h4>
                        <p class="text-sm mt-2 text-gray-300">${data.PitchReport || 'Pitch report abhi available nahi hai.'}</p>
                        <p class="text-sm mt-2 font-extrabold text-yellow-300">Toss Decision Suggestion: <span class="highlight-text">${data.TossDecisionPrediction || 'N/A'}</span></p>
                        <p class="text-sm mt-2 font-extrabold text-red-300">Expected 1st Innings Score: <span class="highlight-text">${data.FirstInningsScoreRange || 'N/A'}</span></p>
                    </div>
                </div>
                
                <!-- TOP PERFORMERS -->
                <div class="card p-4 mb-6 border-l-4 border-yellow-500">
                    <h3 class="font-bold text-lg text-yellow-400">üåü FANTASY/KEY PLAYERS</h3>
                    <div class="mt-2 space-y-2">
                        <p class="text-sm text-gray-300">üèè **Batsmen (Top Picks):** ${data.TopPerformersLikely.Batsmen || 'N/A'}</p>
                        <p class="text-sm text-gray-300">‚öæ **Bowlers (Wicket Takers):** ${data.TopPerformersLikely.Bowlers || 'N/A'}</p>
                    </div>
                </div>
            `;

            // Key Battles Section
            if (data.KeyBattles && data.KeyBattles.length > 0) {
                html += `
                    <div class="card p-4 mb-6 border-l-4 border-red-500">
                        <h3 class="font-bold text-lg text-red-400 mb-3">‚öîÔ∏è KEY BATTLES (Head-to-Head)</h3>
                        <ul class="space-y-3">
                `;
                data.KeyBattles.forEach(battle => {
                    html += `<li class="p-3 rounded-lg border border-gray-600" style="background-color: #1f2937;">
                                <span class="font-extrabold text-green-300">${battle.player1 || 'Player 1'}</span> vs <span class="font-extrabold text-yellow-300">${battle.player2 || 'Player 2'}</span>
                                <p class="text-xs text-gray-400 mt-1">${battle.context || 'Context not available.'}</p>
                             </li>`;
                });
                html += `</ul></div>`;
            }

            // --- CALL TO ACTION / MONETIZATION SECTION (Report ke baad) ---
            html += `
                <h3 class="text-xl font-extrabold text-center text-orange-400 mt-8 mb-4">üèÜ Aage Ki Strategy Aur Live Updates</h3>

                <!-- Betting Partner Link -->
                <a href="${AFFILIATE_LINK}" target="_blank" class="w-full inline-block p-4 rounded-xl money-link font-extrabold text-center text-white text-lg mb-4 shadow-xl transition duration-200">
                    üí∞ Is Match Par Bet Karein! (Official Partner)
                </a>

                <!-- Telegram Group Link (Aapki demand par sabse neeche) -->
                <a href="${PREMIUM_TELEGRAM_LINK}" target="_blank" class="w-full inline-block p-4 rounded-xl bg-blue-600 hover:bg-blue-700 font-extrabold text-center text-white text-lg transition duration-200">
                    üì¢ Free Tips & Live Score Updates Ke Liye Group Join Karein
                </a>
                <p class="text-center text-xs text-gray-500 mt-2">Sari post-toss analysis aur final report Telegram channel mein share hoti hai.</p>
            `;


            resultArea.innerHTML = html;
        }
    </script>
</body>
</html>

